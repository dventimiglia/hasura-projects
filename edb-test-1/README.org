#+options: ':nil *:t -:t ::t <:t H:3 \n:nil ^:t arch:headline
#+options: author:t broken-links:nil c:nil creator:nil
#+options: d:(not "LOGBOOK") date:t e:t email:nil f:t inline:t num:t
#+options: p:nil pri:nil prop:nil stat:t tags:t tasks:t tex:t
#+options: timestamp:t title:t toc:t todo:t |:t
#+title: EDB Test Plan
#+date: <2022-06-03 Fri>
#+author: David A. Ventimiglia
#+email: davidaventimiglia@hasura.io
#+language: en
#+select_tags: export
#+exclude_tags: noexport
#+creator: Emacs 29.0.50 (Org mode 9.5.3)
#+cite_export:

* Databases
** Postgres
*** Schema
**** DONE Table Basics
- [ ] Add database
- [ ] Add account and product tables
- [ ] Add account and product data
- [ ] Perform CRUD operations
  - Read
    #+begin_src graphql
      query MyQuery {
        account(order_by: {name: asc}, limit: 10) {
          id
          name
          created_at
          updated_at
        }
      }
    #+end_src
    #+begin_src graphql
      query MyQuery {
        product(order_by: {price: asc}, limit: 10) {
          id
          name
          price
          updated_at
          created_at
        }
      }
    #+end_src
  - Insert
    #+begin_src graphql
      mutation MyMutation {
        insert_account(objects: {name: "John Doe"}) {
          affected_rows
        }
      }
    #+end_src
    #+begin_src graphql
      mutation MyMutation {
        insert_product(objects: {name: "Doughnut", price: 100}) {
          returning {
            id
            name
            price
            updated_at
            created_at
          }
        }
      }
    #+end_src
  - Update
    #+begin_src graphql
      mutation MyMutation {
        update_account(where: {name: {_eq: "John Doe"}}, _set: {name: "Jane Doe"}) {
          affected_rows
        }
      }
    #+end_src
  - Delete
    #+begin_src graphql
      mutation MyMutation {
        delete_product(where: {name: {_eq: "Doughnut"}}) {
          affected_rows
        }
      }
    #+end_src
**** DONE Table Relationships
- [ ] Add the order and order detail tables
- [ ] Add relationships for account, order, order detail, and product
- [ ] Generate order and order detail data
- [ ] Perform queries across relationships

  
  #+begin_src graphql
    query MyQuery {
      account(limit: 2) {
        id
        name
        created_at
        updated_at
        orders {
          id
          created_at
          updated_at
          order_details {
            id
            created_at
            updated_at
            units
            product {
              id
              name
              created_at
              updated_at
              price
            }
          }
        }
      }
    }
  #+end_src
**** TODO Remote Relationships
**** DONE Extend with Views
- [ ] Add account_summary view and relationships
- [ ] Query across table and view relationships


  #+begin_src graphql
    query MyQuery {
      account_summary(limit: 10) {
        id
        sum
        account {
          name
        }
      }
    }
  #+end_src
**** DONE Extend with SQL Functions
- [ ] Add search functions
- [ ] Query search functions


  #+begin_src graphql
    query MyQuery {
      product_search(args: {search: "apple"}) {
        name
        price
      }
    }
  #+end_src
  #+begin_src graphql
    query MyQuery {
      product_fuzzy_search(args: {search: "apple"}) {
        name
        price
      }
    }
  #+end_src
**** DONE Default field values
**** DONE Enum type fields
- [ ] Create a native Postgres enum type for order status.
- [ ] Create a enum table for region and track it as order sales_region.
**** DONE Computed fields
- [ ] Add product_sku function and track it as a computed field
- [ ] Query product table with computed field


  #+begin_src graphql
    query MyQuery {
      product {
        id
        name
        price
        sku
      }
    }
  #+end_src

**** DONE Customize auto-generated fields
- [ ] Change order.status to order.state for the GraphQL field name

**** DONE Data validations
- [ ] Add non_negative_price check constraint
- [ ] Attempt mutations with and without negative prices


  #+begin_src graphql
    mutation MyMutation {
      update_product(where: {name: {_eq: "Chilli Paste, Sambal Oelek"}}, _set: {price: 10}) {
        affected_rows
      }
    }
  #+end_src

  #+begin_src graphql
    mutation MyMutation {
      update_product(where: {name: {_eq: "Pastry - Raisin Muffin - Mini"}}, _set: {price: -10}) {
        affected_rows
      }
    }
  #+end_src

**** DONE Using an existing database
**** DONE Relay Schema
- [ ] Turn on the Relay API in the Console


#+begin_src graphql
  query MyQuery {
    account_connection(first: 10) {
      edges {
        node {
          name
          orders {
            id
            sales_region {
              description
            }
            order_details {
              units
              product {
                name
                price
                sku
              }
            }
          }
        }
        cursor
      }
    }
  }
#+end_src
*** Queries
**** DONE Simple object queries
**** DONE Nested object queries
**** DONE Aggregation queries
#+begin_src graphql
  query MyQuery {
    account_aggregate {
      aggregate {
        count
      }
    }
  }
#+end_src
#+begin_src graphql
  query MyQuery {
    account(limit: 10) {
      orders {
        order_details_aggregate {
          aggregate {
            sum {
              units
            }
          }
        }
      }
    }
  }
#+end_src
**** TODO Filter query results / search queries
**** TODO Sort query results
**** TODO Distinct query results
**** TODO Using multiple arguments
**** TODO Multiple queries in a request
**** TODO Using variables / aliases / fragments / directives
**** TODO Query performance
*** Mutations
**** TODO Insert
**** TODO Upsert
**** TODO Update
**** TODO Delete
**** TODO Multiple mutations in a request
*** Subscriptions
**** TODO Live queries
**** TODO Streaming subscriptions
*** Supported Postgres types
* Remote Schemas
*** Remote relationships
***** DONE To remote database
***** TODO To Remote Schema
*** Authorization in remote schemas
***** TODO Forwarding auth context to/from remote schemas
***** TODO Remote schema permissions
***** TODO Bypassing Hasura's auth for remote schemas
* Event Triggers
*** Creating an Event Trigger
***** DONE Create an insert trigger
***** DONE Create an update trigger
- [ ] Perform a mutation to update an order
- [ ] Update an order from the Console


#+begin_src graphql
  mutation MyMutation {
    update_order_by_pk(pk_columns: {id: "1564344e-e528-43de-b88e-dab9c3efa44e"}, _set: {state: "fulfilled"}) {
      id
      state
    }
  }
#+end_src

- [ ] Check the events logs
* Scheduled Triggers
*** Creating a chron trigger
***** DONE Create a chron trigger
- [ ] Allow time to pass
- [ ] Check the events logs
*** Creating a one-off scheduled event
***** TODO Create a one-off scheduled event
*** Cleaning up scheduled triggers data
***** TODO Clear Everything
- [ ] Cron triggers

  #+begin_src sql
  DELETE FROM hdb_catalog.hdb_cron_events;
  #+end_src

- [ ] Scheduled events

  #+begin_src sql
  DELETE FROM hdb_catalog.hdb_scheduled_events;
  #+end_src
